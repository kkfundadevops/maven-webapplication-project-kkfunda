name: CI Build → Sonar  → Tomcat

on:
  workflow_dispatch:

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      war-path: ${{ steps.find-war.outputs.war }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build package
        run: mvn -B clean package

      - name: Find WAR
        id: find-war
        run: |
          WAR=$(ls target/*.war 2>/dev/null | head -n 1 || true)
          if [ -z "$WAR" ]; then
            echo "war=" >> $GITHUB_OUTPUT
            echo "No WAR found" >&2
            exit 1
          fi
          echo "war=$WAR" >> $GITHUB_OUTPUT

      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: war-artifact
          path: ${{ steps.find-war.outputs.war }}

  sonar:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: SonarQube analysis
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify sonar:sonar -Dsonar.host.url=${{ env.SONAR_HOST_URL }} -Dsonar.login=${{ env.SONAR_TOKEN }}

  tomcat-deploy:
    runs-on: ubuntu-latest
    needs: nexus-deploy
    steps:
      - name: Download WAR
        uses: actions/download-artifact@v4
        with:
          name: war-artifact
          path: ./target

      - name: Show WAR (debug)
        run: ls -la target/*.war || true

      - name: Deploy to Tomcat manager
        env:
          TOMCAT_URL: ${{ secrets.TOMCAT_URL }}
          TOMCAT_USER: ${{ secrets.TOMCAT_USERNAME }}
          TOMCAT_PASS: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          WAR_FILE=$(ls target/*.war | head -n 1)
          if [ -z "$WAR_FILE" ]; then
            echo "WAR not found" >&2
            exit 1
          fi
          curl -sS -u "${TOMCAT_USER}:${TOMCAT_PASS}" --upload-file "$WAR_FILE" "${TOMCAT_URL}/manager/text/deploy?path=/maven-web-application&update=true"
